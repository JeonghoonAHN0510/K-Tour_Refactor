<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ktour.model.mapper.PushPopupMapper">



    <!-- 1. 검색 -->
    <select id="searchPush" resultType="ktour.model.dto.PushPopupDto">
        SELECT
        *,
        CASE
        WHEN ppStart &gt;  NOW() THEN '진행전'
        WHEN ppEnd   &lt;  NOW() THEN '진행완료'
        ELSE '진행중'
        END AS status
        FROM pushPopup
        <where>
            <if test="ppUse != null and ppUse != ''">      <!-- 빈문자열도 제외 -->
                AND ppUse = #{ppUse}
            </if>
            <if test="ppType != null and ppType != ''">
                AND ppType = #{ppType}
            </if>
            <if test="ppTitle != null and ppTitle != ''">
                AND ppTitle LIKE CONCAT('%', #{ppTitle}, '%')
            </if>
            <if test="status != null and status != ''">
                AND (
                (#{status} = '1'   AND ppStart &gt;  NOW())
                OR (#{status} = '2'   AND ppStart &lt;= NOW() AND ppEnd &gt;= NOW())
                OR (#{status} = '3' AND ppEnd &lt;  NOW())
                )
            </if>
        </where>

        ORDER BY createdAt DESC
    </select>

    <!-- 3. 삭제 -->
    <delete id="deletePush" parameterType="int">
        DELETE FROM pushPopup WHERE ppNo = #{ppNo};
    </delete>

    <!-- 4. 수정 -->
    <update id="updatePush" parameterType="ktour.model.dto.PushPopupDto">
        UPDATE pushPopup SET pNo = #{pNo} , mgNo = #{mgNo} , ppTitle = #{ppTitle} , ppContent = #{ppContent} , ppUse = #{ppUse} , ppType =  #{ppType} , ppStart = #{ppStart} , ppEnd = #{ppEnd} , ppIterated = #{ppIterated} WHERE ppNo = #{ppNo};
    </update>
    
    <!-- 5. 배너 출력 -->
    <select id="bannerPush" resultType="ktour.model.dto.PushPopupDto">
        SELECT ppNo, pNo, mgNo, ppTitle, ppContent, ppImg, ppUse, ppType, ppStart, ppEnd, ppIterated
        FROM pushPopup
        WHERE ppUse IN ('1', '3')
        AND ( ppStart IS NULL OR ppStart &lt;= NOW())
        AND ( ppEnd IS NULL OR ppEnd &gt;= NOW())
        ORDER BY COALESCE(ppStart, createdAt) DESC, ppNo DESC
        LIMIT 11
    </select>


</mapper>